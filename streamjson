#!/usr/bin/env ruby

require 'rubygems'
require 'optparse'
require 'net/http'
require 'uri'
require 'json'
require 'term/ansicolor'
require 'open-uri'
require 'tempfile'
require 'mime/types'
require 'ascii-image'

class String
    include Term::ANSIColor

    def valid_float?
        true if Float self rescue false
    end
end

class Color
    extend Term::ANSIColor
end

#class Config
#    
#end

class StreamJSON
    attr_accessor :server_location
    
    def initialize(server_location = "http://localhost:4881")
        @server_location = server_location
    end
    
    private
    def get_video_list
        url = "#{@server_location}/list"
        resp = Net::HTTP.get_response URI.parse(url)
        
        if resp.kind_of? Net::HTTPOK
            JSON.parse resp.body
        else
            abort "Could not connect to the stream.json server."
        end
    end
    
    def store_tmp_poster(id)
        uri = URI.parse "#{@server_location}/getPoster/#{id}"
        http = Net::HTTP.new(uri.host, uri.port)
        resp = http.get(uri.path)
        
        if resp.kind_of? Net::HTTPOK
            #resp.body
            ext = MIME::Types[resp["content-type"]].first.extensions.first
            
            File.open("/tmp/streamjson_#{id}.#{ext}", "wb+") do |file|
                file.write resp.body
                return file.path
            end
        else
            abort "Could not connect to the stream.json server."
        end
    end
    
    public
    def list
        # List videos.
        videos = get_video_list
        
        puts "Videos"
        videos["video"].each_with_index do |curr_video, index|
            print "    ", "#{index} ", "(#{curr_video["id"]})".cyan, ": ", "#{curr_video["title"]}".bold, "\n"
        end
    end
    
    def detail(id)
        # Details on the video.
        videos = get_video_list["video"]
        selected = nil
        
        if id.valid_float?
            selected = videos[id.to_i]
        elsif id.is_a? String
            selected = videos.select do |key, hash|
                key["id"] == id
            end
            selected = selected[0]
        else
            puts "You've entered a invalid ID."
        end
        
        if selected.nil?
            # ID doesn't exist
            puts "You've entered a ID that doesn't exist on the list."
        else
            # Show the details
            print Color.bold, selected["title"], Color.clear, "\n"
            
            poster = ASCII_Image.new store_tmp_poster(selected["id"])
            poster.build 15
            print "\n"
            
            puts selected["description"]["text"]
        end
    end
    
    def play(id)
        # Play video.
        url = "#{@server_location}/getVideo/#{id}"
        resp = Net::HTTP.get_response URI.parse(url)
        video_location = JSON.parse resp.body
        
        exec "mplayer -fs #{video_location}"
    end
end

if __FILE__ == $0
    streamjson = StreamJSON.new
    
    opt_parser = OptionParser.new do |opt|
        opt.version = "streamjson 0.1 (c) 2012 Nathan Campos\nThe awesome stream.json client for your awesome command-line."
        opt.banner = "Usage: streamjson option [id]"
        opt.separator ""
        opt.separator "Options"
        
        # List videos
        opt.on("-l", "--list", "List videos") do
            streamjson.list
        end
        
        # Detail video.
        opt.on("-d", "--detail id", "Display details of a video") do |id|
            streamjson.detail id
        end
        
        # Play video.
        opt.on("-p", "--play id", "Plays the video") do |id|
            streamjson.play id
        end
        
        # Usage
        opt.on("-h", "--help", "Help") do
            puts opt_parser
        end
    end
    
    if ARGV[0].nil?
        puts opt_parser
    else
        opt_parser.parse!
    end
end